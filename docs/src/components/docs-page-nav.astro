---
import { categoriesCollectionName } from "@/content/functions/content.config";
import { categoriesV1CollectionName } from "@/content/functions/v1/content.config";
import { getArticlesForPath } from "@/lib/docs";
import { getMappingEntries } from "@/lib/mapping/entries";
import { getNavbarEntries } from "@/lib/navbar-entries";
import { getCollection } from "astro:content";
import { MobileNav } from "./mobile-nav";
import { VERSIONS } from "./version-selector";

const MIGRATION_REGEXP = /^\/migrate\/(?<library>\w+)\/?$/iu;

const { pathname } = Astro.url;
const normalizedPathname = pathname.replace(/\/$/, "");

const migrationLibrary = MIGRATION_REGEXP.exec(pathname)?.groups?.library;

const entries =
  migrationLibrary !== undefined
    ? await getMappingEntries(migrationLibrary)
    : normalizedPathname === VERSIONS.v1.path
      ? await getCollection(categoriesV1CollectionName)
      : normalizedPathname === VERSIONS.latest.path
        ? await getCollection(categoriesCollectionName)
        : undefined;

const articles = await getArticlesForPath(pathname);

const navbarEntries =
  entries === undefined ? [] : await getNavbarEntries(entries, articles);
---

<MobileNav
  showVersionSelector={migrationLibrary === undefined}
  title={migrationLibrary}
  pathname={pathname}
  categories={navbarEntries}
  client:media="(max-width: 767px)"
/>
