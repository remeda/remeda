---
import MappingFunctionCard from "@/components/mapping-function-card.astro";
import DocsPage from "@/layouts/docs-page.astro";
import { getCollection } from "astro:content";
import {
  entries,
  flat,
  fromEntries,
  groupBy,
  map,
  mapValues,
  pipe,
  sortBy,
  values,
} from "remeda";

const COLLECTION = "mapping";
const LIBRARY = "lodash";

const REGEX = new RegExp(`^${LIBRARY}\/(?<name>.*)\.mdx?$`, "ui");

const mapping = await getCollection(COLLECTION, ({ id }) => REGEX.test(id));

const categorized = pipe(
  mapping,
  groupBy(({ data: { category } }) => category),
  mapValues(map(({ id }) => ({ name: id.replace(REGEX, "$1") }))),
  entries(),
  sortBy(([category]) => category),
  fromEntries(),
);
---

<DocsPage
  categorized={categorized}
  collectionQuery={({ id }) => id.startsWith("lodash/")}
>
  {
    pipe(
      categorized,
      values(),
      flat(),
      map(({ name }) => <MappingFunctionCard name={name} library={LIBRARY} />),
    )
  }
</DocsPage>
